name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type (patch, minor, major). Ignored when 'version' is set."
        required: false
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: "Explicit version to set (e.g. 1.2.3). Overrides bump_type when provided."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  bump:
    name: Bump Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute new version
        id: version
        run: |
          # Determine the latest semver tag (strips the leading 'v')
          LATEST=$(git tag --list 'v*' --sort=-version:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          # Strip leading 'v' and drop any pre-release/build metadata (e.g. 1.2.3-beta+build -> 1.2.3)
          CURRENT=$(echo "${LATEST#v}" | sed 's/[-+].*//')
          echo "Current version: $CURRENT"

          EXPLICIT="${{ inputs.version }}"
          if [ -n "$EXPLICIT" ]; then
            # Strip leading 'v' and any pre-release/build metadata
            NEW_VERSION=$(echo "${EXPLICIT#v}" | sed 's/[-+].*//')
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            case "${{ inputs.bump_type }}" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              *)     PATCH=$((PATCH + 1)) ;;
            esac
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          NEW_TAG="v${NEW_VERSION}"

          # Fail early if the tag already exists
          if git rev-parse --verify --quiet "refs/tags/${NEW_TAG}" > /dev/null; then
            echo "::error::Tag ${NEW_TAG} already exists. Choose a different version."
            exit 1
          fi

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "new_tag=$NEW_TAG"         >> "$GITHUB_OUTPUT"

      - name: Update Helm chart appVersion
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          CHART="charts/amazing-gitlab-exporter/Chart.yaml"
          # Replace the appVersion line in-place (preserves surrounding content)
          sed -i "s/^appVersion:.*$/appVersion: \"v${NEW_VERSION}\"/" "$CHART"
          grep "^appVersion:" "$CHART"

      - name: Commit chart change
        env:
          NEW_TAG: ${{ steps.version.outputs.new_tag }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/amazing-gitlab-exporter/Chart.yaml
          # Skip commit if there are no staged changes (e.g. re-running with same version)
          if git diff --staged --quiet; then
            echo "No changes to commit (appVersion already at ${NEW_TAG})"
          else
            git commit -m "chore: bump appVersion to ${NEW_TAG}"
          fi

      - name: Create and push tag
        env:
          NEW_TAG: ${{ steps.version.outputs.new_tag }}
        run: |
          git tag "$NEW_TAG"
          git push origin HEAD:"${{ github.ref_name }}" --follow-tags
