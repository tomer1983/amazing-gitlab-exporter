suite: ServiceMonitor
templates:
  - templates/servicemonitor.yaml
values:
  - ../ci/default-values.yaml
tests:
  - it: should not create ServiceMonitor by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ServiceMonitor when enabled
    set:
      serviceMonitor.enabled: true
    asserts:
      - isKind:
          of: ServiceMonitor
      - equal:
          path: spec.endpoints[0].port
          value: http
      - equal:
          path: spec.endpoints[0].path
          value: /metrics

  - it: should configure custom interval
    set:
      serviceMonitor.enabled: true
      serviceMonitor.interval: 15s
      serviceMonitor.scrapeTimeout: 5s
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: 15s
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 5s

  - it: should add extra labels
    set:
      serviceMonitor.enabled: true
      serviceMonitor.labels:
        release: prometheus
    asserts:
      - equal:
          path: metadata.labels.release
          value: prometheus
